rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper function to check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // Helper function to check if user is the owner of a resource
    function isOwner(ownerId) {
      return isAuthenticated() && request.auth.uid == ownerId;
    }
    
    // Helper function to check if user is a collaborator
    function isCollaborator(collaborators) {
      return isAuthenticated() && request.auth.uid in collaborators;
    }
    
    // Users collection - users can read their own data and create on signup
    match /users/{userId} {
      allow read: if isAuthenticated();
      allow write: if isOwner(userId);
    }
    
    // Shopping Lists collection - strict access control
    match /lists/{listId} {
      // Allow read if user is owner OR collaborator
      allow read: if isAuthenticated() && (
        isOwner(resource.data.ownerId) || 
        isCollaborator(resource.data.collaborators)
      );
      
      // Allow create if user is authenticated (user becomes owner)
      allow create: if isAuthenticated() && 
        request.resource.data.ownerId == request.auth.uid;
      
      // Allow update if user is owner OR collaborator
      allow update: if isAuthenticated() && (
        isOwner(resource.data.ownerId) || 
        isCollaborator(resource.data.collaborators)
      );
      
      // Allow delete only if user is owner
      allow delete: if isAuthenticated() && 
        isOwner(resource.data.ownerId);
      
      // Items sub-collection within a list
      match /items/{itemId} {
        // Inherit permissions from parent list
        allow read, write: if isAuthenticated() && (
          isOwner(get(/databases/$(database)/documents/lists/$(listId)).data.ownerId) ||
          isCollaborator(get(/databases/$(database)/documents/lists/$(listId)).data.collaborators)
        );
      }
    }
    
    // Carts collection - same access control as lists
    match /carts/{cartId} {
      // Allow read if user is owner OR collaborator
      allow read: if isAuthenticated() && (
        isOwner(resource.data.ownerId) || 
        isCollaborator(resource.data.collaborators)
      );
      
      // Allow create if user is authenticated
      allow create: if isAuthenticated() && 
        request.resource.data.ownerId == request.auth.uid;
      
      // Allow update if user is owner OR collaborator
      allow update: if isAuthenticated() && (
        isOwner(resource.data.ownerId) || 
        isCollaborator(resource.data.collaborators)
      );
      
      // Allow delete only if user is owner
      allow delete: if isAuthenticated() && 
        isOwner(resource.data.ownerId);
    }
    
    // Deny all other reads/writes by default
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
